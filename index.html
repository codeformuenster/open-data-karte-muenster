
<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Layers Control Example</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
        <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>

    <style>
        body {padding: 0; margin: 0 }
        html, body, #map { height: 100% }
        table { border-collapse: collapse;}
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .change {padding-left:3px;font-size:14px;}
        .green { color: #090 }
        .red {color:#900 }
        .changer  {margin-top:20px; display:block!important;}
        .selector {float:right;}
        tr.high td {font-weight:bold;}
        .info strong {
            display:block;
            margin: 0 0 5px;
            color: #777;
        }
        .topmargin {margin-top:10px;}
        .history {
            margin: 10px 0 0 0;
            font-weight:bold;
            color: #777;
        }
        .legend {
            text-align: left;
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        .nextone {width:100%;}
        @media (min-width: 800px) {
            .info { font-size:24px;line-height:26px;}
            .legend i {width: 26px;height: 26px;}
            .rtext {font-size:24px;}
        }

    </style>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

</head>
<body>
    <div id="map"></div>






    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h3 class="modal-title" id="myModalLabel">Open Data Karte Münster - Datensatz auswählen</h3>
          </div>
          <div class="modal-body">
            Bitte wählen Sie aus, welchen Datensatz Sie in der Karte anzeigen möchten:

            <div class="bs-example topmargin" data-example-id="block-btns">
                <div class="well center-block" id="dataSelector">
                </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>




    <script type="text/javascript" src="maps/Ebene_2_Stadtteil.geojson.js"></script>
    <script type="text/javascript">


        var mapColors = ["#FFFFFF", "#FFF1D5", "#FFE4AB", "#FFD781", "#FFCA57", "#FFBD2E", "#EE9724", "#DE711B", "#CD4B12", "#BD2509", "#AD0000"]; 
        //["#FF0000", "#FE1C00", "#FD3800", "#FC5500", "#FB7100", "#FA8D00", "#F9AA00", "#F8C600", "#F7E200", "#F7FF00", "#FAFF33"];

        var dataSet = function() {

            var openData = {
                'wohnberechtigte' : {
                    'title' : 'Wohnberechtigte nach Alter',
                    'unit': 'Personen',
                    'default': 3,
                    'limits' : [ 0, 100,200, 400, 600, 800,1000,2000,3000,4000,5000 ],
                    'headlines':[ '',"0 - 9","10 - 19","20 - 29","30 - 39","40 - 49","50 - 59","60 - 69","70 - 79","80 - 89","90 u. mehr" ],
                    'data' : {
                        11 : [ 1450,83,73,402,232,162,137,98,144,80,39 ],
                        12 : [ 1354,35,77,601,213,128,89,77,73,48,13 ],
                        13 : [ 2199,74,82,737,409,231,192,148,189,120,17 ],
                        14 : [ 2432,81,103,890,343,253,186,131,155,184,106 ],
                        15 : [ 1384,47,74,497,229,141,146,85,103,54,8 ],
                        21 : [ 4522,167,223,1701,841,378,352,200,297,270,93 ],
                        22 : [ 8688,392,375,3082,1739,952,845,513,473,262,55 ],
                        23 : [ 1251,45,36,612,243,108,91,45,38,28,5 ],
                        24 : [ 6932,336,275,2393,1579,807,704,398,257,163,20 ],
                        25 : [ 6260,396,331,1798,1259,846,705,425,324,145,31 ],
                        26 : [ 5284,410,407,962,868,785,693,486,440,196,37 ],
                        27 : [ 12524,785,733,3282,2162,1589,1525,1134,817,383,114 ],
                        28 : [ 4338,187,296,1984,669,351,331,248,174,74,24 ],
                        29 : [ 2210,132,114,531,344,217,273,183,211,151,54 ],
                        31 : [ 5479,418,430,931,730,675,750,562,590,333,60 ],
                        32 : [ 8976,684,650,1832,1467,1232,1218,829,622,347,95 ],
                        33 : [ 7688,482,406,2290,1624,916,822,467,420,203,58 ],
                        34 : [ 7036,570,682,961,847,1080,1037,687,647,431,94 ],
                        43 : [ 1045,49,23,410,246,122,74,45,43,25,8 ],
                        44 : [ 5202,301,285,1188,886,611,584,346,470,388,143 ],
                        45 : [ 10220,681,721,1841,1665,1386,1519,886,866,550,105 ],
                        46 : [ 8099,669,880,1306,979,1131,1319,677,678,384,76 ],
                        47 : [ 8605,755,643,2023,1376,1174,1088,686,532,268,60 ],
                        51 : [ 21155,2145,2486,5899,2872,2664,2177,1370,913,516,113 ],
                        52 : [ 7631,532,743,2949,860,707,707,435,369,243,86 ],
                        54 : [ 9250,643,1133,1505,819,1363,1563,921,812,424,67 ],
                        56 : [ 6244,762,805,570,781,1013,935,592,514,235,37 ],
                        57 : [ 9082,986,956,1174,1190,1424,1230,904,815,351,52 ],
                        58 : [ 6769,593,646,954,800,899,960,751,805,324,37 ],
                        61 : [ 10555,1382,1257,1382,1310,1388,1526,918,868,449,75 ],
                        62 : [ 4998,476,463,704,636,672,784,546,466,222,29 ],
                        63 : [ 10513,1148,1122,1459,1138,1255,1573,1239,1058,454,67 ],
                        68 : [ 3102,312,363,285,333,491,496,323,323,156,20 ],
                        71 : [ 10317,889,930,1121,1304,1623,1626,1063,1068,603,90 ],
                        76 : [ 3692,384,404,338,389,609,600,438,357,151,22 ],
                        77 : [ 8017,886,909,692,838,1263,1221,785,945,395,83 ],
                        81 : [ 4932,445,593,707,563,793,827,435,354,181,34 ],
                        82 : [ 6522,610,769,724,762,1087,1072,623,537,291,47 ],
                        86 : [ 7930,824,846,943,975,1088,1196,846,787,365,60 ],
                        87 : [ 8981,846,952,824,977,1347,1456,1038,1070,402,69 ],
                        91 : [ 5640,575,634,775,738,710,789,513,523,307,76 ],
                        95 : [ 6350,450,636,584,599,860,1071,893,895,325,37 ],
                        96 : [ 9881,745,888,1224,1189,1433,1428,1058,1166,620,130 ],
                        97 : [ 9284,882,1113,1007,1072,1471,1635,1069,779,230,26 ],
                        98 : [ 6244,697,804,540,778,1099,866,581,588,251,40 ],
                    },
                    'tableTitle' : 'Gestaffelt nach Alter'
                },
                'arbeitslose' : {
                    'title' : 'Anzahl der Arbeitslosen',
                    'unit' : 'Personen',
                    'extra' : 'showChange',
                    'headlines' :  [ 2010,2011,2012,2013,2014 ],
                    'default' : 4,
                    'limits' : [0,50,100,150,200,250,300,350,400,500,600],
                    'data' : {
                        11 : [ 29,32,31,36,36 ],
                        12 : [ 25,25,27,17,21 ],
                        13 : [ 35,33,32,33,45 ],
                        14 : [ 44,46,42,42,37 ],
                        15 : [ 25,24,22,32,26 ],
                        21 : [ 75,70,90,94,94 ],
                        22 : [ 268,307,346,359,334 ],
                        23 : [ 38,38,39,49,43 ],
                        24 : [ 214,235,229,236,248 ],
                        25 : [ 123,144,127,129,130 ],
                        26 : [ 133,112,132,140,146 ],
                        27 : [ 221,217,224,221,221 ],
                        28 : [ 83,83,93,91,94 ],
                        29 : [ 26,25,28,35,37 ],
                        31 : [ 129,141,133,133,132 ],
                        32 : [ 289,251,307,287,303 ],
                        33 : [ 240,246,274,280,291 ],
                        34 : [ 170,177,170,171,163 ],
                        43 : [ 30,39,34,38,35 ],
                        44 : [ 129,138,157,148,133 ],
                        45 : [ 229,202,239,225,193 ],
                        46 : [ 171,151,180,189,181 ],
                        47 : [ 309,309,336,346,327 ],
                        51 : [ 469,493,553,544,556 ],
                        52 : [ 96,112,106,106,120 ],
                        54 : [ 207,165,196,169,204 ],
                        56 : [ 111,120,114,151,142 ],
                        57 : [ 230,216,214,223,235 ],
                        58 : [ 154,167,168,189,184 ],
                        61 : [ 696,723,766,728,698 ],
                        62 : [ 201,197,209,186,181 ],
                        63 : [ 625,645,666,646,591 ],
                        68 : [ 72,68,72,63,81 ],
                        71 : [ 182,200,237,238,217 ],
                        76 : [ 64,66,77,74,77 ],
                        77 : [ 166,171,169,195,222 ],
                        81 : [ 141,149,153,155,187 ],
                        82 : [ 150,162,166,159,167 ],
                        86 : [ 320,335,365,349,368 ],
                        87 : [ 198,206,233,216,243 ],
                        91 : [ 281,302,321,346,306 ],
                        95 : [ 111,120,132,126,119 ],
                        96 : [ 356,326,369,381,348 ],
                        97 : [ 292,287,286,298,284 ],
                        98 : [ 94,114,121,108,109 ]
                    },
                },
                'haushalte': {
                    'title': 'Anzahl der Haushalte',
                    'unit': 'Haushalte',
                    'extra' : 'showChange',                    
                    'headlines': [ '','','2010','2011','2012','2013','2014' ],
                    'default': 6,
                    'limits' : [ 0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000 ],
                    'data': { 
                        11 : ["Aegidii",,903,998,1001,995,959],
                        12 : ["Überwasser",,954,1073,1049,1054,1019],
                        13 : ["Dom",,1508,1642,1602,1611,1585],
                        14 : ["Buddenturm",,1401,1538,1546,1583,1589],
                        15 : ["Martini",,931,1017,1024,1025,1027],
                        21 : ["Pluggendorf",,2761,3079,3072,3098,3140],
                        22 : ["Josef",,5640,6046,6031,6227,6217],
                        23 : ["Bahnhof",,818,895,880,936,968],
                        24 : ["Hansaplatz",,4655,5015,5024,4981,5024],
                        25 : ["Mauritz-West",,3978,4257,4238,4252,4282],
                        26 : ["Schlachthof",,2856,3062,3101,3139,3145],
                        27 : ["Kreuz",,7678,8287,8266,8223,8235],
                        28 : ["Neutor",,2717,3159,3071,3004,3005],
                        29 : ["Schloss",,1185,1314,1295,1304,1303],
                        31 : ["Aaseestadt",,2990,3108,3132,3159,3121],
                        32 : ["Geist",,5093,5342,5328,5350,5411],
                        33 : ["Schützenhof",,4707,5063,5063,5148,5152],
                        34 : ["Düesberg",,3410,3485,3504,3543,3549],
                        43 : ["Hafen",,727,801,785,793,776],
                        44 : ["Herz-Jesu",,2759,2911,2926,2904,2956],
                        45 : ["Mauritz-Mitte",,5944,6181,6117,6211,6241],
                        46 : ["Rumphorst",,3990,4153,4212,4286,4265],
                        47 : ["Uppenberg",,4604,4990,5024,5079,5117],
                        51 : ["Gievenbeck",,8998,10170,10428,10661,10748],
                        52 : ["Sentrup",,3766,4339,4422,4451,4542],
                        54 : ["Mecklenbeck",,4407,4697,4206,4306,4570],
                        56 : ["Albachten",,2324,2414,2464,2504,2558],
                        57 : ["Roxel",,3953,4185,4254,4264,4336],
                        58 : ["Nienberge",,3196,3395,3391,3440,3433],
                        61 : ["Coerde",,4506,4673,4714,4791,4885],
                        62 : ["Kinderhaus-Ost",,2560,2623,2628,2649,2661],
                        63 : ["Kinderhaus-West",,4678,4905,4895,4913,4914],
                        68 : ["Sprakel",,1260,1269,1298,1332,1364],
                        71 : ["Mauritz-Ost",,5004,5200,5295,5343,5375],
                        76 : ["Gelmer-Dyckburg",,1536,1584,1625,1658,1682],
                        77 : ["Handorf",,3290,3421,3474,3476,3521],
                        81 : ["Gremmendorf-West",,2163,2215,2225,2367,2430],
                        82 : ["Gremmendorf-Ost",,2907,2978,3012,3080,3109],
                        86 : ["Angelmodde",,3528,3626,3655,3831,3857],
                        87 : ["Wolbeck",,3927,4025,4062,4137,4183],
                        91 : ["Berg Fidel",,2491,2580,2583,2586,2614],
                        95 : ["Hiltrup-Ost",,2968,3016,2986,2995,3014],
                        96 : ["Hiltrup-Mitte",,4947,5093,5150,5164,5166],
                        97 : ["Hiltrup-West",,3938,4083,4174,4208,4278],
                        98 : ["Amelsbüren",,2322,2384,2422,2439,2426]
                    }
                }
            };

            var currentDataSet = 'undef';
            var currentSubSet = 0;

            function selectDataSet( dsname ) {
                if  ( !dsname ) { dsname = "arbeitslose-4"; }
                var myArray = /^(.+)-(\d+)$/g.exec(dsname);
                currentDataSet = myArray ? myArray[1] : dsname;
                currentSubSet = myArray ? myArray[2] : openData[dsname].default;
                if  ( !openData[currentDataSet].headlines[currentSubSet] ) { location.href="?"; }
                showDataSelector(  );
            }
            function getDataSet() { return openData[currentDataSet]; }
            function getData() { return openData; }
            function getTitle() { return openData[currentDataSet].title + " " + openData[currentDataSet].headlines[currentSubSet]; }
            function getUnit() { return openData[currentDataSet].unit; }
            function getLimits() { return openData[currentDataSet].limits; }
            function getDataItem( stadtteilNr ) { return openData[currentDataSet]['data'][stadtteilNr][currentSubSet]; }
            function getDataTable( stadtteilNr ) { 
                var table = {};
                var lastVal = 0;
                var hls = openData[currentDataSet].headlines;
                for (var i = 0; i < hls.length; i++ ) {
                    if ( hls[i]) {
                        var currentVal = openData[currentDataSet]['data'][stadtteilNr][i];
                        var change = lastVal ? currentVal - lastVal  : 0; 
                        table[ hls[i] ] = [ currentVal , change, ( i == currentSubSet  ? 1: 0 )];
                        lastVal = currentVal;
                    }
                }                
                return table;
            }
            function getDataItemColor( stadtteilNr ) {
                var currentVal = getDataItem( stadtteilNr );
                var a = getLimits();
                var len = a.length;
                var currentNr = len-1;
                for (var i = 0; i < len; i++ ) {
                  if ( currentVal <= a[i] ) {
                    currentNr = i-1;
                    break;
                  }
                }
                return mapColors[currentNr];
            }

            // list all datasets for "select dataset" popup
            function showDataSelector( ) {
                $.each( openData, function( key, arr ) {
//                    $("#dataSelector").append('<div class="nextone rtext"><b>' + arr.title + '</b> <button type="button" class="selector btn btn-default" data-id="'+key+'">Datensatz auswählen</button> </div><br clear="all" />');

                    var select_html = '<select class="selector-d form-control input-lg"><option value=""> Auswahl </option>';

                    var len = arr.headlines.length;
                    for (var i = 0; i < len; i++ ) {
                        if ( !arr.headlines[i] ) { continue; }
                        var thiskey = key+"-"+ i;
                        select_html += '<option value="' + thiskey + '" '+ ( thiskey == ( currentDataSet + '-' + currentSubSet ) ? "selected" : "" ) +'> ' + arr.headlines[i] + '</option>';
                    }
                    select_html += '</select>';

                    $("#dataSelector").append('<div class="row topmargin"><div class="col-md-8"><button type="button" data-id="'+key+'" class="selector btn '+ ( (currentDataSet == key) ? "btn-primary" : "btn-default" ) +' btn-lg btn-block">' + arr.title + '</button></div><div class="col-md-4">' + select_html + '</div></div>' ) ;

                });
                $("#dataSelector").append('<br clear="both" />');
                $(".selector").click( function( ) { location.href="?" + $( this ).data('id'); });
                $(".selector-d").change( function() { location.href="?" + $( this ).val(); })
                console.log("selected dataset", currentDataSet, currentSubSet );
            }

            return {
                getUnit:getUnit,
                getTitle:getTitle,
                getLimits:getLimits,
                getDataSet:getDataSet,
                getDataItem:getDataItem,
                getDataTable:getDataTable,
                selectDataSet:selectDataSet,
                getDataItemColor:getDataItemColor
            };
        }();

        var showData = location.search.substr( 1 );
        if ( !showData ) {
            $('#myModal').modal('show');
        }
        dataSet.selectDataSet( showData );

        function getColor( i ) {
            return mapColors[i];
        }

        var map = L.map('map').setView([ 51.962, 7.629], 11);

        L.tileLayer(
            'http://{s}.tiles.mapbox.com/v3/tomrocket.m8l1e9gm/{z}/{x}/{y}.png', {
                maxZoom: 16,
                minZoom: 11,
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                    '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                    'Imagery © <a href="http://mapbox.com">Mapbox</a>',                 
            }
        ).addTo(map);


        // control that shows state info on hover
        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };

        info.update = function (props) {
            var html = '<strong>'+ dataSet.getTitle() +'</strong>';
            html = html +  (props ?
                '<b>' + props.Name + '</b><br />' + dataSet.getDataItem( props.Nr ) +' '+ dataSet.getUnit() + ' '
                : 'Navigieren Sie über einen Stadtteil');

            // draw nice history table
            if ( props ) {
                var hls = dataSet.getDataTable( props.Nr );
                var tbl = dataSet.getDataSet( );
                var htitle = tbl.tableTitle || "Historie";
                html += '<div class="history">' + htitle + '</div> <table>';
                $.each( hls, function( key, value ) {
                  html += value[2] ? '<tr class="high">' : '<tr>';
                  html += '<td>' + key + ':</td><th>' + value[0] + '</th>';
                  if ( tbl.extra == "showChange" ) {
                    html += '<td class="change ' + ( value[1] > 0 ? "green" : "red" ) + '">' + ( value[1] ? ( value[1] > 0 ? '+' : '' ) + value[1] : '' ) + '</td>';
                  }
                  html += '</tr>';
                });
                html += '</table>';
            }


            this._div.innerHTML = html;


        };

        info.addTo(map);



        function style(feature) {
            return {
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7,
                fillColor: dataSet.getDataItemColor( feature.properties.Nr )  
            };
        }

        function highlightFeature(e) {
            var layer = e.target;

            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.7
            });

            if (!L.Browser.ie && !L.Browser.opera) {
                layer.bringToFront();
            }

            info.update(layer.feature.properties);
        }

        var geojson;

        function resetHighlight(e) {
            geojson.resetStyle(e.target);
            info.update();
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        geojson = L.geoJson(stadtteileMuenster2, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(map);

        map.attributionControl.addAttribution('Jahresstatistiken &copy; <a href="http://www.muenster.de/stadt/stadtplanung/zahlen.html">Stadt Münster</a>');


        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                grades = dataSet.getLimits(),
                labels = [],
                from, to;

            for (var i = 0; i < grades.length; i++) {
                from = grades[i];
                to = grades[i + 1];

                labels.push(
                    '<i style="background:' + getColor(i) + '"></i> ' +
                    from + (to ? '&ndash;' + to : '+'));
            }

            div.innerHTML = labels.join('<br>') + '<button type="button" class="changer btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">Datensatz ändern</button>';
            return div;
        };

        legend.addTo(map);

    </script>












</body>
</html>
